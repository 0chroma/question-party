/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

/*
	This is a compiled version of Dojo, built for deployment and not for
	development. To get an editable version, please visit:

		http://dojotoolkit.org

	for documentation and information on getting the source.
*/

if(!dojo._hasResource["dojox.data.restListener"]){dojo._hasResource["dojox.data.restListener"]=true;dojo.provide("dojox.data.restListener");dojox.data.restListener=function(_1){var _2=_1.channel;var jr=dojox.rpc.JsonRest;var _3=jr.getServiceAndId(_2).service;var _4=dojox.json.ref.resolveJson(_1.result,{defaultId:_1.event=="put"&&_2,index:dojox.rpc.Rest._index,idPrefix:_3.servicePath.replace(/[^\/]*$/,""),idAttribute:jr.getIdAttribute(_3),schemas:jr.schemas,loader:jr._loader,assignAbsoluteIds:true});var _5=dojox.rpc.Rest._index&&dojox.rpc.Rest._index[_2];var _6="on"+_1.event.toLowerCase();var _7=_3&&_3._store;if(_5){if(_5[_6]){_5[_6](_4);return;}}if(_7){switch(_6){case "onpost":_7.onNew(_4);break;case "ondelete":_7.onDelete(_5);break;}}};}if(!dojo._hasResource["dojox.rpc.Client"]){dojo._hasResource["dojox.rpc.Client"]=true;dojo.provide("dojox.rpc.Client");(function(){dojo._defaultXhr=dojo.xhr;dojo.xhr=function(_8,_9){var _a=_9.headers=_9.headers||{};_a["Client-Id"]=dojox.rpc.Client.clientId;_a["Seq-Id"]=dojox._reqSeqId=(dojox._reqSeqId||0)+1;return dojo._defaultXhr.apply(dojo,arguments);};})();dojox.rpc.Client.clientId=(Math.random()+"").substring(2,14)+(new Date().getTime()+"").substring(8,13);}if(!dojo._hasResource["dojox.cometd.RestChannels"]){dojo._hasResource["dojox.cometd.RestChannels"]=true;dojo.provide("dojox.cometd.RestChannels");(function(){dojo.declare("dojox.cometd.RestChannels",null,{constructor:function(_b){dojo.mixin(this,_b);if(dojox.rpc.Rest&&this.autoSubscribeRoot){var _c=dojox.rpc.Rest._get;var _d=this;dojox.rpc.Rest._get=function(_e,id){var _f=dojo.xhrGet;dojo.xhrGet=function(r){var _10=_d.autoSubscribeRoot;return (_10&&r.url.substring(0,_10.length)==_10)?_d.get(r.url,r):_f(r);};var _11=_c.apply(this,arguments);dojo.xhrGet=_f;return _11;};}},absoluteUrl:function(_12,_13){return new dojo._Url(_12,_13)+"";},acceptType:"application/rest+json,application/http;q=0.9,*/*;q=0.7",subscriptions:{},subCallbacks:{},autoReconnectTime:3000,reloadDataOnReconnect:true,sendAsJson:false,url:"/channels",autoSubscribeRoot:"/",open:function(){this.started=true;if(!this.connected){this.connectionId=dojox.rpc.Client.clientId;var _14=this.createdClientId?"Client-Id":"Create-Client-Id";this.createdClientId=true;var _15={Accept:this.acceptType};_15[_14]=this.connectionId;var dfd=dojo.xhrPost({headers:_15,url:this.url,noStatus:true});var _16=this;this.lastIndex=0;var _17,_18=function(_19){if(typeof dojo=="undefined"){return null;}if(xhr&&xhr.status>400){return _17(true);}if(typeof _19=="string"){_19=_19.substring(_16.lastIndex);}var _1a=xhr&&(xhr.contentType||xhr.getResponseHeader("Content-Type"))||(typeof _19!="string"&&"already json");var _1b=_16.onprogress(xhr,_19,_1a);if(_1b){if(_17()){return new Error(_1b);}}if(!xhr||xhr.readyState==4){xhr=null;if(_16.connected){_16.connected=false;_16.open();}}return _19;};_17=function(_1c){if(xhr&&xhr.status==409){console.log("multiple tabs/windows open, polling");_16.disconnected();return null;}_16.createdClientId=false;_16.disconnected();return _1c;};dfd.addCallbacks(_18,_17);var xhr=dfd.ioArgs.xhr;if(xhr){xhr.onreadystatechange=function(){var _1d;try{if(xhr.readyState==3){_16.readyState=3;_1d=xhr.responseText;}}catch(e){}if(typeof _1d=="string"){_18(_1d);}};}if(window.attachEvent){window.attachEvent("onunload",function(){_16.connected=false;if(xhr){xhr.abort();}});}this.connected=true;}},_send:function(_1e,_1f,_20){if(this.sendAsJson){_1f.postData=dojo.toJson({target:_1f.url,method:_1e,content:_20,params:_1f.content,subscribe:_1f.headers["Subscribe"]});_1f.url=this.url;_1e="POST";}else{_1f.postData=dojo.toJson(_20);}return dojo.xhr(_1e,_1f,_1f.postData);},subscribe:function(_21,_22){_22=_22||{};_22.url=this.absoluteUrl(this.url,_21);if(_22.headers){delete _22.headers.Range;}var _23=this.subscriptions[_21];var _24=_22.method||"HEAD";var _25=_22.since;var _26=_22.callback;var _27=_22.headers||(_22.headers={});this.subscriptions[_21]=_25||_23||0;var _28=this.subCallbacks[_21];if(_26){this.subCallbacks[_21]=_28?function(m){_28(m);_26(m);}:_26;}if(!this.connected){this.open();}if(_23===undefined||_23!=_25){_27["Cache-Control"]="max-age=0";_25=typeof _25=="number"?new Date(_25).toUTCString():_25;if(_25){_27["Subscribe-Since"]=_25;}_27["Subscribe"]=_22.unsubscribe?"none":"*";var dfd=this._send(_24,_22);var _29=this;dfd.addBoth(function(_2a){var xhr=dfd.ioArgs.xhr;if(!(_2a instanceof Error)){if(_22.confirmation){_22.confirmation();}}if(xhr&&xhr.getResponseHeader("Subscribed")=="OK"){var _2b=xhr.getResponseHeader("Last-Modified");if(xhr.responseText){_29.subscriptions[_21]=_2b||new Date().toUTCString();}else{return null;}}else{if(xhr&&!(_2a instanceof Error)){delete _29.subscriptions[_21];}}if(!(_2a instanceof Error)){var _2c={responseText:xhr&&xhr.responseText,channel:_21,getResponseHeader:function(_2d){return xhr.getResponseHeader(_2d);},getAllResponseHeaders:function(){return xhr.getAllResponseHeaders();},result:_2a};if(_29.subCallbacks[_21]){_29.subCallbacks[_21](_2c);}}else{if(_29.subCallbacks[_21]){_29.subCallbacks[_21](xhr);}}return _2a;});return dfd;}return null;},publish:function(_2e,_2f){return this._send("POST",{url:_2e,contentType:"application/json"},_2f);},_processMessage:function(_30){_30.event=_30.event||_30.getResponseHeader("Event");if(_30.event=="connection-conflict"){return "conflict";}try{_30.result=_30.result||dojo.fromJson(_30.responseText);}catch(e){}var _31=this;var loc=_30.channel=new dojo._Url(this.url,_30.source||_30.getResponseHeader("Content-Location"))+"";if(loc in this.subscriptions&&_30.getResponseHeader){this.subscriptions[loc]=_30.getResponseHeader("Last-Modified");}if(this.subCallbacks[loc]){setTimeout(function(){_31.subCallbacks[loc](_30);},0);}this.receive(_30);return null;},onprogress:function(xhr,_32,_33){if(!_33||_33.match(/application\/rest\+json/)){var _34=_32.length;_32=_32.replace(/^\s*[,\[]?/,"[").replace(/[,\]]?\s*$/,"]");try{var _35=dojo.fromJson(_32);this.lastIndex+=_34;}catch(e){}}else{if(dojox.io&&dojox.io.httpParse&&_33.match(/application\/http/)){var _36="";if(xhr&&xhr.getAllResponseHeaders){_36=xhr.getAllResponseHeaders();}_35=dojox.io.httpParse(_32,_36,xhr.readyState!=4);}else{if(typeof _32=="object"){_35=_32;}}}if(_35){for(var i=0;i<_35.length;i++){if(this._processMessage(_35[i])){return "conflict";}}return null;}if(!xhr){return "error";}if(xhr.readyState!=4){return null;}if(xhr.__proto__){xhr={channel:"channel",__proto__:xhr};}return this._processMessage(xhr);},get:function(_37,_38){(_38=_38||{}).method="GET";return this.subscribe(_37,_38);},receive:function(_39){if(dojox.data&&dojox.data.restListener){dojox.data.restListener(_39);}},disconnected:function(){var _3a=this;if(this.connected){this.connected=false;if(this.started){setTimeout(function(){var _3b=_3a.subscriptions;_3a.subscriptions={};for(var i in _3b){if(_3a.reloadDataOnReconnect&&dojox.rpc.JsonRest){delete dojox.rpc.Rest._index[i];dojox.rpc.JsonRest.fetch(i);}else{_3a.subscribe(i,{since:_3b[i]});}}_3a.open();},this.autoReconnectTime);}}},unsubscribe:function(_3c,_3d){_3d=_3d||{};_3d.unsubscribe=true;this.subscribe(_3c,_3d);},disconnect:function(){this.started=false;this.xhr.abort();}});var _3e=dojox.cometd.RestChannels.defaultInstance=new dojox.cometd.RestChannels();if(dojox.cometd.connectionTypes){_3e.startup=function(_3f){_3e.open();this._cometd._deliver({channel:"/meta/connect",successful:true});};_3e.check=function(_40,_41,_42){for(var i=0;i<_40.length;i++){if(_40[i]=="rest-channels"){return !_42;}}return false;};_3e.deliver=function(_43){};dojo.connect(this,"receive",null,function(_44){_44.data=_44.result;this._cometd._deliver(_44);});_3e.sendMessages=function(_45){for(var i=0;i<_45.length;i++){var _46=_45[i];var _47=_46.channel;var _48=this._cometd;var _49={confirmation:function(){_48._deliver({channel:_47,successful:true});}};if(_47=="/meta/subscribe"){this.subscribe(_46.subscription,_49);}else{if(_47=="/meta/unsubscribe"){this.unsubscribe(_46.subscription,_49);}else{if(_47=="/meta/connect"){_49.confirmation();}else{if(_47=="/meta/disconnect"){_3e.disconnect();_49.confirmation();}else{if(_47.substring(0,6)!="/meta/"){this.publish(_47,_46.data);}}}}}}};dojox.cometd.connectionTypes.register("rest-channels",_3e.check,_3e,false,true);}})();}
